<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ON/OFF Logger with Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    button { font-size: 18px; padding: 10px 25px; margin: 10px; border: none; border-radius: 10px; cursor: pointer; }
    .on { background-color: green; color: white; }
    .off { background-color: red; color: white; }
    .download { background-color: blue; color: white; }
    #loading { display: none; font-size: 20px; color: green; }
    #statusButton { 
      font-size: 24px; 
      padding: 15px 40px; 
      border-radius: 15px; 
      margin-bottom: 20px;
      transition: background-color 0.5s, transform 0.3s;
    }
    #timer { font-size: 28px; margin: 20px; }
  </style>
</head>
<body>

<button id="statusButton">Sultanabad</button>
<div id="timer">00:00:00</div>

<button id="onButton" class="on">ON</button>
<button id="offButton" class="off">OFF</button>
<br><br>
<button id="downloadButton" class="download">Download Logs (Excel)</button>
<p id="loading">Downloading...</p>

<table id="logTable" border="1" style="margin: 30px auto; border-collapse: collapse;">
  <thead>
    <tr><th>Timestamp</th><th>Action</th></tr>
  </thead>
  <tbody>
    <!-- Logs will appear here -->
  </tbody>
</table>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAy53-F5QZ5a0f9DW9emesit1KA2T7v7Do",
    authDomain: "testt-b241d.firebaseapp.com",
    projectId: "testt-b241d",
    storageBucket: "testt-b241d.appspot.com",
    messagingSenderId: "288476078303",
    appId: "1:288476078303:android:ff06d4a9d5c432f41ac96a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const statusDoc = db.collection('status').doc('buttonState');
  const logsCol = db.collection('logs');

  const statusButton = document.getElementById('statusButton');
  const timerDiv = document.getElementById('timer');
  const onBtn = document.getElementById('onButton');
  const offBtn = document.getElementById('offButton');
  const downloadBtn = document.getElementById('downloadButton');
  const loadingText = document.getElementById('loading');
  const logTable = document.getElementById('logTable').querySelector('tbody');

  let timerInterval = null;
  let startTime = null;

  onBtn.onclick = async () => {
    disableButtons();
    const now = new Date().toISOString();
    await statusDoc.set({ currentStatus: "ON", f_on: now, f_off: null });
    await logsCol.add({ action: "ON", timestamp: now });
    updateUI('ON', now);
    fetchLogs();
  };

  offBtn.onclick = async () => {
    disableButtons();
    const now = new Date().toISOString();
    await statusDoc.set({ currentStatus: "OFF", f_on: null, f_off: now });
    await logsCol.add({ action: "OFF", timestamp: now });
    updateUI('OFF', now);
    fetchLogs();
  };

  function disableButtons() {
    onBtn.disabled = true;
    offBtn.disabled = true;
  }

  async function fetchStatus() {
    const doc = await statusDoc.get();
    if (doc.exists) {
      const data = doc.data();
      updateUI(data.currentStatus, data.f_off);
    } else {
      statusButton.style.backgroundColor = "grey";
    }
  }

  function updateUI(state, time = null) {
    statusButton.style.transform = "scale(1.1)";
    setTimeout(() => {
      statusButton.style.transform = "scale(1)";
    }, 300);

    if (state === "ON") {
      statusButton.style.backgroundColor = "green";
      statusButton.style.color = "white";
      onBtn.disabled = true;
      offBtn.disabled = false;
      stopTimer();
    } else if (state === "OFF") {
      statusButton.style.backgroundColor = "red";
      statusButton.style.color = "white";
      onBtn.disabled = false;
      offBtn.disabled = true;
      if (time) {
        startTimer(new Date(time));
      } else {
        startTimer(new Date());
      }
    }
  }

  function startTimer(start) {
    if (timerInterval) clearInterval(timerInterval);
    startTime = start;
    timerInterval = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - startTime) / 1000);
      const hours = String(Math.floor(diff / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
      const seconds = String(diff % 60).padStart(2, '0');
      timerDiv.textContent = `${hours}:${minutes}:${seconds}`;
    }, 1000);
  }

  function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    timerDiv.textContent = "00:00:00";
  }

  async function fetchLogs() {
    const snapshot = await logsCol.orderBy('timestamp', 'desc').limit(50).get();
    logTable.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = `<tr><td>${data.timestamp ? new Date(data.timestamp).toLocaleString() : "No time"}</td><td>${data.action || "Unknown"}</td></tr>`;
      logTable.innerHTML += row;
    });
  }

  // Download button logic with interruption calculation
  downloadBtn.onclick = async () => {
    loadingText.style.display = 'block';
    try {
      const snapshot = await logsCol.orderBy('timestamp').get();
      const logs = snapshot.docs.map(doc => doc.data());

      const processedLogs = [];
      let lastOnTime = null;

      logs.forEach(entry => {
        if (entry.action === "ON") {
          lastOnTime = new Date(entry.timestamp);
        } else if (entry.action === "OFF" && lastOnTime) {
          const offTime = new Date(entry.timestamp);
          const diffMs = offTime - lastOnTime;
          const diffMins = Math.floor(diffMs / 60000);
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;

          processedLogs.push({
            Date: lastOnTime.toLocaleDateString(),
            Name: "Sultanabad",
            Time: offTime.toLocaleTimeString(),
            Interruption: `${hours} hr ${minutes} min`
          });
          lastOnTime = null; // Reset after pairing
        }
      });

      if (processedLogs.length === 0) {
        alert('No complete ON/OFF pairs found.');
        loadingText.style.display = 'none';
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(processedLogs);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Logs");
      XLSX.writeFile(workbook, "logs_with_interruption.xlsx");
      alert('Logs downloaded successfully!');
    } catch (error) {
      console.error('Error downloading logs:', error);
      alert('Error downloading logs. See console for details.');
    } finally {
      loadingText.style.display = 'none';
    }
  };

  // Initialize on page load
  fetchStatus();
  fetchLogs();
</script>

</body>
</html>
