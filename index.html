downloadBtn.onclick = async () => {
  loadingText.style.display = 'block';
  try {
    const [snapshot1, snapshot2] = await Promise.all([
      logsCol.orderBy('timestamp').get(),
      logsColTown.orderBy('timestamp').get()
    ]);

    console.log("Snapshot1:", snapshot1);
    console.log("Snapshot2:", snapshot2);

    const allLogs = [...snapshot1.docs.map(doc => ({...doc.data(), location: "Sultanabad"})),
                     ...snapshot2.docs.map(doc => ({...doc.data(), location: "Town"}))];

    allLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    // Prepare data for the Excel sheet
    const logsForExcel = allLogs.map(data => {
      const logDate = new Date(data.timestamp);
      const dateFormatted = logDate.toLocaleDateString('en-GB'); // 'DD/MM/YYYY'
      const timeFormatted = logDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

      // Calculate the interruption time
      let interruptionTime = '--'; // Default to "--" if no interruption time
      let lastOffAction = data.location === "Sultanabad" ? lastOffSultanabad : lastOffTown;

      if (data.action === "ON" && lastOffAction) {
        const offTime = new Date(lastOffAction.timestamp);
        const onTime = new Date(data.timestamp);

        const diffMs = onTime - offTime;
        if (diffMs >= 0) {
          const h = String(Math.floor(diffMs / 3600000)).padStart(2, '0');
          const m = String(Math.floor((diffMs % 3600000) / 60000)).padStart(2, '0');
          const s = String(Math.floor((diffMs % 60000) / 1000)).padStart(2, '0');
          interruptionTime = `${h}:${m}:${s}`;
        }
      }

      // Update the last "OFF" action for the location if this is an "OFF" action
      if (data.action === "OFF") {
        if (data.location === "Sultanabad") {
          lastOffSultanabad = data;
        } else if (data.location === "Town") {
          lastOffTown = data;
        }
      }

      return {
        Date: dateFormatted,
        Action: data.action,
        Time: timeFormatted,
        Location: data.location,
        Interruption: interruptionTime
      };
    });

    console.log("Logs for Excel:", logsForExcel); // Verify the data structure

    // Generate the worksheet from the formatted data
    const worksheet = XLSX.utils.json_to_sheet(logsForExcel);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Logs");

    // Write the Excel file
    XLSX.writeFile(workbook, "combined_logs.xlsx");

    alert('Logs downloaded successfully!');
  } catch (error) {
    console.error('Error downloading logs:', error);
    alert('Error downloading logs. See console for details.');
  } finally {
    loadingText.style.display = 'none';
  }
};
